# 알림 기능 테스트 가이드

## ✅ 수정 완료 사항

1. **환경변수 적용** - `pushNotification.js`에서 ngrok URL 사용
2. **상세한 에러 로깅** - 네트워크 오류 원인 파악 가능
3. **프론트엔드 재시작** - 환경변수 적용됨

## 🔗 현재 URL

- **프론트엔드 (아이폰에서 접속)**: https://0e9dfc1769e2.ngrok-free.app
- **백엔드**: https://a1130d59a001.ngrok-free.app

## 📱 아이폰 테스트 순서

### 1단계: 기존 앱 삭제 (중요!)
```
홈 화면에서 "통학버스" 앱 길게 누르기 → 앱 제거
```

### 2단계: Safari로 접속
```
Safari 열기
주소: https://0e9dfc1769e2.ngrok-free.app
```

### 3단계: 홈 화면에 추가
```
1. Safari 하단 공유 버튼(□↑) 탭
2. "홈 화면에 추가" 선택
3. "추가" 버튼 클릭
```

### 4단계: 홈 화면 앱으로 실행
```
홈 화면에서 "통학버스" 앱 아이콘 탭
(Safari가 아닌 독립 앱으로 실행되어야 함)
```

### 5단계: 로그인
```
학번과 비밀번호 입력
```

### 6단계: 알림 받기
```
1. "알림 받기" 버튼 클릭
2. "허용" 선택
3. 성공 메시지 확인
```

## 🔍 디버깅 방법

### Safari 개발자 도구로 확인

**Mac에서:**
1. Safari > 개발용 > [아이폰 이름] > [통학버스 앱]
2. 콘솔 탭에서 로그 확인

**확인할 로그:**
```javascript
// 성공 시
푸시 토큰 저장 시도: {url: "...", studentId: "...", ...}
푸시 토큰 저장 성공: {...}

// 실패 시
푸시 토큰 저장 실패: {message: "...", response: {...}, ...}
```

### 데이터베이스 확인

Supabase에서 확인:
```sql
SELECT student_id, apn_token, fcm_token, updated_at 
FROM users 
WHERE student_id = '당신의학번';
```

## ⚠️ 예상되는 문제와 해결

### 문제 1: "네트워크 오류: 서버에 연결할 수 없습니다"
**원인**: 백엔드 ngrok URL이 잘못됨
**해결**: 
```bash
# 터미널에서 확인
curl https://a1130d59a001.ngrok-free.app/health

# 응답이 없으면 ngrok 재시작
pkill ngrok
ngrok start --all
```

### 문제 2: "서버 오류 (404): 회원을 찾을 수 없습니다"
**원인**: 로그인한 학번이 DB에 없음
**해결**: 회원가입 먼저 진행

### 문제 3: "서버 오류 (500)"
**원인**: 백엔드 서버 오류
**해결**: 백엔드 로그 확인
```bash
# 백엔드 터미널에서 에러 확인
```

### 문제 4: 알림 권한 창이 안 뜸
**원인**: Safari 브라우저로 접속함
**해결**: 반드시 홈 화면 앱으로 실행

### 문제 5: CORS 에러
**원인**: ngrok 무료 버전의 제한
**해결**: ngrok 경고 페이지에서 "Visit Site" 클릭

## 🎯 성공 확인 방법

### 1. 콘솔 로그
```
iOS 디바이스 감지: {standalone: true, ...}
푸시 토큰 저장 성공: {message: "푸시 토큰이 업데이트되었습니다.", ...}
```

### 2. Alert 메시지
```
알림이 활성화되었습니다!
디바이스: ios
토큰: apn_1733...
```

### 3. 데이터베이스
```
apn_token 컬럼에 값이 저장됨
```

### 4. 테스트 알림
```
브라우저 알림: "✅ 알림 설정 완료!"
```

## 📊 현재 상태 체크리스트

- [x] 백엔드 실행 중 (포트 8000)
- [x] 프론트엔드 실행 중 (포트 5173)
- [x] ngrok 터널 2개 실행 중
- [x] .env 파일에 백엔드 URL 설정
- [x] CORS 설정 완료
- [x] API 엔드포인트 정상
- [x] 환경변수 적용 완료

## 🚀 다음 단계

알림이 정상적으로 설정되면:
1. 모니터링 시작 버튼 클릭
2. 관리자가 예매 오픈
3. 앱이 실행 중일 때 알림 수신 확인

**중요**: iOS는 앱이 포그라운드에서 실행 중일 때만 알림을 받을 수 있습니다!
